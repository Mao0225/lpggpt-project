<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备列表</title>
    <script src="../css/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="../css/bootstrap-4.3.1-dist/css/bootstrap.min.css">
    <script src="../css/bootstrap-4.3.1-dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/lpg.css">

    <style>
        .container {
            padding: 50px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        input {
            padding: 15px;
            font-size: 18px;
            border: 2px solid #a3bffa;
            border-radius: 10px;
            width: 100%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #4c87c9;
        }
    </style>

    <style>
        #pagediv {
            background-color: #f0f0f0;
            color: black;
            padding: 10px;
            margin-bottom: 15px;
        }

        table.list {
            width: 100%;
            border-collapse: collapse;
        }

        table.list th {
            background-color: #add8e6;
            color: black;
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }

        table.list td {
            padding: 8px;
            border: 1px solid #ddd;
        }

        table.list tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        table.list tr:nth-child(odd) {
            background-color: #e0e0e0;
        }

        table.list tr:hover {
            background-color: #d3d3d3;
        }

        #pagediv .add {
            color: black;
            margin-right: 15px;
        }

        #pagediv input[type="text"] {
            background-color: #f0f0f0;
        }

        #pagediv label {
            color: black;
        }

        .operation-btn {
            margin-right: 10px;
            text-decoration: none;
        }
    </style>
</head>

<body>
<div id="pagediv">
    <a href="/xhzinfo/add" class="add operation-btn">添加设备</a>

    <form id="searchForm" action="/xhzinfo/xhzlist" method="post">
        <label>饭店名称：</label>
        <select name="restaurantId" id="companySelect">
            <option value="" #if(restaurantId == "") selected #end>全部公司</option>
            #for(x : restaurants)
            <option value="#(x.id)" #if(restaurantId == (x.id + "")) selected #end>#(x.name)</option>
            #end
        </select>

        &nbsp;&nbsp;
        <select name="alarm" onchange="this.form.submit()" id="alarmSelect">
            <option value="" #if(alarm == null || alarm == "") selected #end>请选择报警类型</option>
            <option value="0" #if(alarm != null && alarm.toString() == "0") selected #end>无报警</option>
            <option value="1" #if(alarm != null && alarm.toString() == "1") selected #end>操作间燃气报警</option>
            <option value="2" #if(alarm != null && alarm.toString() == "2") selected #end>气瓶间燃气报警</option>
            <option value="3" #if(alarm != null && alarm.toString() == "3") selected #end>摄像头监控报警</option>
            <option value="4" #if(alarm != null && alarm.toString() == "4") selected #end>烟感报警</option>
            <option value="5" #if(alarm != null && alarm.toString() == "5") selected #end>管道压力超压报警</option>
        </select>

        <button type="submit" value="查询" id="searchButton">查询</button>
        <button type="button" value="重置" id="resetButton">重置</button>
    </form>

</div>

<table class="list">
    <tbody>
    <tr>
        <th>序号</th>
        <th>iot实例id</th>
        <th>产品key</th>
        <th>设备名称</th>
        <th>创建时间</th>
        <th>请求编码</th>
        <th>1号电机阀状态</th>
        <th>2号电机阀状态</th>
        <th>3号电机阀状态</th>
        <th>4号电机阀状态</th>
        <th>切断阀状态</th>
        <th>报警信息</th>
        <th>气体压力状态</th>
        <th>系统供电状态</th>
        <th>电子标签1</th>
        <th>电子标签2</th>
        <th>电子标签3</th>
        <th>电子标签4</th>
        <th>电子标签5</th>
        <th>电子标签6</th>
        <th>电子标签7</th>
        <th>电子标签8</th>
        <th>操作</th>
    </tr>
    #set(startIndex = (recordlist.pageNumber - 1) * recordlist.pageSize + 1)
    #for(x : recordlist.getList())
    <tr>
        <td>#(startIndex++)</td>
        <td>#(x.iotId)</td>
        <td>#(x.productKey)</td>
        <td>#(x.devicename)</td>
        <td class="created-time">#(x.created_time)</td>
        <td>#(x.requestid)</td>
        <td>
            #if(x.get("ValveStatus1") == null)
            #else if(x.get("ValveStatus1") == 0)
            关
            #else if(x.get("ValveStatus1") == 1)
            开
            #else
            <span style="color: red;">未知值</span>
            #end
        </td>

        <td>
            #if(x.get("ValveStatus2") == null)
            #else if(x.get("ValveStatus2") == 0)
            关
            #else if(x.get("ValveStatus2") == 1)
            开
            #end
        </td>

        <td>
            #if(x.get("ValveStatus3") == null)
            #else if(x.get("ValveStatus3") == 0)
            关
            #else if(x.get("ValveStatus3") == 1)
            开
            #end
        </td>
        <td>
            #if(x.get("ValveStatus4") == null)
            #else if(x.get("ValveStatus4") == 0)
            关
            #else if(x.get("ValveStatus4") == 1)
            开
            #end
        </td>
        <td>
            #if(x.get("M_ValStat") == null)
            #else if(x.get("M_ValStat") ==1)
            开
            #else if(x.get("M_ValStat") ==0)
            关
            #end
        </td>
        <td>
            #if(x.get("Alarm") == null)
            #else if(x.get("Alarm") == 0)
            无报警
            #else if(x.get("Alarm") == 1)
            厨房警报
            #else if(x.get("Alarm") == 2)
            气瓶间报警
            #else if(x.get("Alarm") == 3)
            摄像头报警
            #else if(x.get("Alarm") == 4)
            烟感报警
            #else if(x.get("Alarm") == 5)
            防拆卸警报
            #end
        </td>
        <td>
            #if(x.get("Gas_Pg") == null)
            #else if(x.get("Gas_Pg") ==0)
            正常
            #else if(x.get("Gas_Pg") ==1)
            压力低于下限
            #else if(x.get("Gas_Pg") ==2)
            超压
            #end
        </td>
        <td>
            #if(x.get("PowerStatus") == null)
            #else if(x.get("PowerStatus") ==0)
            正常
            #else if(x.get("PowerStatus") ==1)
            故障
            #end
        </td>
        <td class="rfid-data" data-rfid="#(x.Rfid1)"></td>
        <td class="rfid-data" data-rfid="#(x.Rfid2)"></td>
        <td class="rfid-data" data-rfid="#(x.Rfid3)"></td>
        <td class="rfid-data" data-rfid="#(x.Rfid4)"></td>
        <td class="rfid-data" data-rfid="#(x.Rfid5)"></td>
        <td class="rfid-data" data-rfid="#(x.Rfid6)"></td>
        <td class="rfid-data" data-rfid="#(x.Rfid7)"></td>
        <td class="rfid-data" data-rfid="#(x.Rfid8)"></td>

        <td>
            <a href="#" class="edit operation-btn" data-title="编辑设备" data-edit-url="/xhzinfo/edit?id=#(x.id)">修改</a>
            <a href="#" class="delete operation-btn" onclick="confirmDelete('#(x.id)')">删除</a>
        </td>
    </tr>
    #end
    </tbody>
</table>

<div class="pagination" style="color:#333;">
    #set(selectedRestaurantId = "")
    #if(restaurantId!= null && restaurantId!= "")
    #set(selectedRestaurantId = restaurantId)
    #end
    #set(selectedAlarm = "")
    #if(alarm != null)
    #set(selectedAlarm = alarm)
    #end
    #@paginate(recordlist.pageNumber, recordlist.totalPage, "/xhzinfo/xhzlist?restaurantId=" + selectedRestaurantId + "&alarm=" + selectedAlarm + "&page=")
</div>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">模态窗口标题</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="saveButton">保存</button>
            </div>
        </div>
    </div>
</div>

<script>
    var restaurants = [
        #for (x: restaurants)
    {
        id: "#(x.id ? x.id : '')",
            xiaohezi: "#(x.xiaohezi ? x.xiaohezi : '')",
        name: "#(x.name ? x.name : '')"
    }#if(x_has_next),#end
    #end
    ];

    function chooseName() {
        var selectName = document.getElementById("companySelect").value;
        console.log("companySelect: " + selectName);
        var selectedCompany = restaurants.find(function (r) {
            return r.id === selectName;
        });
    }
    document.getElementById("companySelect").addEventListener("change", chooseName);

    $('#searchButton').click(function (e) {
        e.preventDefault();
        $('#searchForm').submit();
    });

    $(document).ready(function () {
        $('#resetButton').click(function (e) {
            e.preventDefault();
            $('#searchForm input[type="text"]').val('');
            $('#companySelect').val('');
            $('#alarmSelect').val('');
            $('#searchForm').submit();
        });

        $('.openModal').click(function (e) {
            e.preventDefault();
            var editUrl = $(this).data('edit-url');
            var that = this;

            $.get(editUrl, function (data) {
                var title = $(that).data('title');
                $('#myModalLabel').text(title);
                $('#modalBody').html(data);
                $('#myModal').modal('show');
            }).fail(function() {
                alert('加载编辑表单失败，请重试');
            });
        });
    });

    function formatDate(timestamp) {
        if (isNaN(timestamp)) return '无效时间';
        var date = new Date(timestamp);
        if (isNaN(date.getTime())) return '无效时间';

        var year = date.getFullYear();
        var month = ('0' + (date.getMonth() + 1)).slice(-2);
        var day = ('0' + date.getDate()).slice(-2);
        var hours = ('0' + date.getHours()).slice(-2);
        var minutes = ('0' + date.getMinutes()).slice(-2);
        var seconds = ('0' + date.getSeconds()).slice(-2);
        return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
    }

    var createdTimeElements = document.querySelectorAll('.created-time');
    createdTimeElements.forEach(function(element) {
        var timestamp = parseInt(element.textContent);
        element.textContent = formatDate(timestamp);
    });

    function convertRfid(rfidStr) {
        if (!rfidStr || typeof rfidStr !== 'string') {
            return '';
        }

        if (!rfidStr.includes('[')) {
            return '';
        }

        rfidStr = rfidStr.substring(1, rfidStr.length - 1);
        const rfidArray = rfidStr.split(',').map(item => item.trim());

        let firstNonZeroIndex = -1;
        for (let i = 1; i < rfidArray.length; i++) {
            if (rfidArray[i] !== '0' && rfidArray[i] !== '') {
                firstNonZeroIndex = i;
                break;
            }
        }

        if (firstNonZeroIndex === -1) {
            return '';
        }

        const targetArray = rfidArray.slice(firstNonZeroIndex, firstNonZeroIndex + 7);
        const hexArray = targetArray.map(value => {
            const intValue = parseInt(value, 10) || 0;
            return intValue.toString(16).padStart(2, '0').toUpperCase();
        });

        return hexArray.join('');
    }

    window.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.rfid-data').forEach(td => {
            const originalData = td.dataset.rfid;
            td.textContent = convertRfid(originalData);
        });
    });

    function confirmDelete(id) {
        if (confirm("确定要删除该设备记录吗？此操作不可恢复！")) {
            // 删除时携带当前筛选条件，保持分页状态
            const restaurantId = document.getElementById('companySelect').value;
            const alarm = document.getElementById('alarmSelect').value;
            let url = "/xhzinfo/delete?id=" + id;
            if (restaurantId) url += "&restaurantId=" + restaurantId;
            if (alarm) url += "&alarm=" + alarm;
            window.location.href = url;
        }
    }

    document.getElementById('saveButton').addEventListener('click', function () {
        const form = document.getElementById('myForm');
        if (form) {
            form.submit();
        } else {
            alert('表单不存在，请刷新页面重试');
        }
    });
</script>
</body>
</html>