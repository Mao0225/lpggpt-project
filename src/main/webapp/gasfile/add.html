<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content</title>
</head>
<body>
<div class="form_box">
    <form id="myForm" action="/gasFile/save" method="post">
        <div>
            <label for="gas_file.gas_number">气瓶编号 </label>
            <input type="text" id="gas_file.gas_number" name="gas_file.gas_number"
                   value="#(gas_file?.gas_number)"
                   onblur="checkGasNumberDuplicate()" />
            <span id="gasNumberTip" style="color: #dc3545; font-size: 12px;"></span>
        </div>
        <div>
            <label >奉天编码 </label>
            <input type="text" id="gas_file.fengtiangasnor" name="gas_file.fengtiangasno"  value="" />
        </div>
        <div>
            <label >镂空码</label>
            <input type="text" id="gas_file.loukongno" name="gas_file.loukongno"  value="" />
        </div>
        <input type="hidden" id="gas_file.gasstationid" name="gas_file.gasstationid"   value="" readonly/>
        <div>
            <label >加气站名字</label>
            <input type="hidden" id="gas_file.filing_gas_station" name="gas_file.filing_gas_station" readonly>
            <input type="hidden" id="gas_file.stationid" name="gas_file.stationid" value="" readonly>
            <select id="selectName" name="gas_file.filing_gas_station" onchange="chooseName(); checkGasNumberDuplicate()" style="border-radius: 5px;background-color: white; width: 200px;height:30px;text-align: center;">
                <option value="-1" selected>请选择加气站名字</option>
                #for ( x: gasstations)
                <option value="#(x.id)">#(x.station_name)</option>
                #end
            </select>
        </div>
        <div>
            <label>制造单位 </label>
            <input type="text" name="gas_file.manufacture_unit"  value="" />
        </div>
        <div>
            <label>电子标签</label>
            <input type="text" name="gas_file.valve_body_code"  value="" />
        </div>
        <div>
            <label>气瓶使用登记证编号</label>
            <input type="text" name="gas_file.qpsydjzbh"  value="瓶30辽AF00008（18）" />
        </div>
        <div>
            <label>制造日期</label>
            <input type="text" name="gas_file.manufacture_date" value="" />
        </div>
        <div>
            <label>检验日期</label>
            <input type="text" name="gas_file.inspect_date"  value="" />
        </div>
        <div>
            <label>定检日期</label>
            <input type="text" name="gas_file.regular_check_date"  value="" />
        </div>
        <div>
            <label>终止使用日期</label>
            <input type="text" name="gas_file.terminate_use_date"  value="" />
        </div>
        <div>
            <label>建档时间</label>
            <input type="text" id="gas_file.jiandangshijian" name="gas_file.jiandangshijian"  value="" />
        </div>
        <div>
            <label>检验机构</label>
            <input type="text" name="gas_file.filling_gas_station"  value="" />
        </div>
        <div>
            <label>设备品种</label>
            <input type="text" name="gas_file.monitoring_station"  value="焊接气瓶" />
        </div>
        <div>
            <label>充装规格</label>
            <input type="text" name="gas_file.filling_specification"  value="15" />
        </div>
        <div>
            <label>气瓶型号</label>
            <input type="text" name="gas_file.gas_specification"  value="YSP35.5" />
        </div>
        <div>
            <label>充装介质</label>
            <input type="text" name="gas_file.filling_medium"  value="液化石油气" />
        </div>
        <div>
            <label>许可证号</label>
            <input type="text" name="gas_file.xukezhenghao"  value="TS2210Q02" />
        </div>
        <div>
            <label>公称压力</label>
            <input type="text" name="gas_file.gongchengyali"  value="2.1" />
        </div>
        <div>
            <label>水试验压</label>
            <input type="text" name="gas_file.shuishiyanya"  value="3.2" />
        </div>
        <div>
            <label>容积</label>
            <input type="text" name="gas_file.rongji"  value="35.5" />
        </div>
        <div>
            <label>壁厚</label>
            <input type="text" name="gas_file.bihou"  value="2.5" />
        </div>
        <div>
            <label>气瓶自重KG</label>
            <input type="text" name="gas_file.gas_suttle"  value="16" />
        </div>
        <div>
            <label>是否专用</label>
            <input type="text" name="gas_file.shifouzhuanyong"  value="专用" />
        </div>
        <div>
            <label>使用者名称</label>
            <input type="text" name="gas_file.shiyongzhemingcheng"  value="" />
        </div>
        <div>
            <label>地址</label>
            <input type="text" name="gas_file.shiyongzhedizhi"  value="" />
        </div>
        <div>
            <label>电话</label>
            <input type="text" name="gas_file.shiyongzhedianhua"  value="" />
        </div>
        <div>
            <label>经度</label>
            <input type="text" name="gas_file.shiyongzhejingdu"  value="" />
        </div>
        <div>
            <label>纬度</label>
            <input type="text" name="gas_file.shiyongzheweidu"  value="" />
        </div>
    </form>
</div>

<script>
    // 初始化建档时间为当前日期
    var currentDate = new Date();
    var year = currentDate.getFullYear();
    var month = ('0' + (currentDate.getMonth() + 1)).slice(-2);
    var day = ('0' + currentDate.getDate()).slice(-2);
    var formattedDate = year + '-' + month + '-' + day;
    var jiandangInput = document.getElementById("gas_file.jiandangshijian");
    if (jiandangInput) {
        jiandangInput.value = formattedDate;
    }

    // 加气站数据（使用控制器传递的JSON字符串，避免模板解析错误）
    var gasstationsData = #(gasstationsJson); // 依赖Controller传递的gasstationsJson属性

    // 选择加气站逻辑
    function chooseName() {
        var selectId = document.getElementById("selectName").value;
        var gasstationIdInput = document.getElementById("gas_file.gasstationid");
        var filingGasStationInput = document.getElementById("gas_file.filing_gas_station");
        var stationIdInput = document.getElementById("gas_file.stationid");

        if (selectId === "-1") {
            gasstationIdInput.value = "";
            filingGasStationInput.value = "";
            stationIdInput.value = "";
            return;
        }

        // 查找选中的加气站
        var selectedGasStation = gasstationsData.find(function(gasstation) {
            return gasstation.id == selectId;
        });

        if (selectedGasStation) {
            gasstationIdInput.value = selectedGasStation.id;
            filingGasStationInput.value = selectedGasStation.station_name || selectedGasStation.stationName; // 兼容不同属性名
            stationIdInput.value = selectedGasStation.id;
        } else {
            gasstationIdInput.value = "";
            filingGasStationInput.value = "";
            stationIdInput.value = "";
            alert('找不到对应的加气站！');
        }
    }

    // 校验气瓶编号（同加气站下唯一）
    function checkGasNumberDuplicate() {
        var tip = document.getElementById("gasNumberTip");
        // 获取气瓶编号和加气站ID
        var gasNumber = document.getElementById("gas_file.gas_number").value.trim();
        var stationId = document.getElementById("gas_file.stationid").value.trim();

        // 1. 空值校验
        if (!gasNumber) {
            tip.innerText = "气瓶编号不能为空！";
            return;
        }
        // 2. 未选择加气站校验
        if (!stationId || stationId === "-1") {
            tip.innerText = "请先选择加气站！";
            tip.style.color = "#dc3545";
            return;
        }

        // 3. 异步请求校验（基础XMLHttpRequest）
        var xhr = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
        // 拼接参数：gasNumber + stationId
        var requestUrl = "/gasFile/checkGasNumber" +
            "?gasNumber=" + encodeURIComponent(gasNumber) +
            "&stationId=" + encodeURIComponent(stationId);

        xhr.open("GET", requestUrl, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    if (xhr.responseText === "duplicate") {
                        alert("当前加气站下该气瓶编号已存在，请更换！");
                        tip.innerText = "当前加气站下该气瓶编号已存在！";
                        tip.style.color = "#dc3545";
                    } else {
                        tip.innerText = "气瓶编号可用";
                        tip.style.color = "#28a745";
                    }
                } else {
                    tip.innerText = "验证失败，请重试";
                    tip.style.color = "#dc3545";
                }
            }
        };
        // 处理网络异常
        xhr.onerror = function() {
            tip.innerText = "网络异常，校验失败";
            tip.style.color = "#dc3545";
        };
        xhr.send();
    }

    // 初始化事件绑定
    document.addEventListener("DOMContentLoaded", function() {
        // 绑定加气站选择事件
        var selectName = document.getElementById("selectName");
        if (selectName) {
            selectName.addEventListener("change", chooseName);
        }
        // 初始化建档时间
        chooseName(); // 初始化加气站默认值
    });
</script>
</body>
</html>