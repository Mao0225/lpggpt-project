<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content</title>
    <link rel="stylesheet" type="text/css" href="../css/lpg.css">

    <style scoped>
        .container {
            padding: 50px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        input {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #a3bffa;
            border-radius: 4px;
            width: 150px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: border-color 0.3s ease;
            margin-right: 10px;
        }

        input:focus {
            outline: none;
            border-color: #4c87c9;
        }

        input[type="submit"],
        input[type="button"] {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            width: auto;
            margin-right: 5px;
        }

        input[type="submit"] {
            background-color: #007bff;
            color: white;
        }

        input[type="button"] {
            background-color: #6c757d;
            color: white;
        }
    </style>

    <style>
        #pagediv {
            background-color: #f0f0f0;
            color: black;
            padding: 10px;
            border: 2px solid #007bff;
        }

        table.list {
            width: 100%;
            border-collapse: collapse;
        }

        table.list th {
            background-color: #add8e6;
            color: black;
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }

        table.list td {
            padding: 8px;
            border: 1px solid #ddd;
            position: relative; /* 新增：为加载指示器提供定位容器 */
        }

        table.list tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        table.list tr:nth-child(odd) {
            background-color: #e0e0e0;
        }

        table.list tr:hover {
            background-color: #d3d3d3;
        }

        #pagediv .add {
            color: white;
            background-color: #007bff;
            padding: 6px 12px;
            text-decoration: none;
            display: inline-block;
            border-radius: 4px;
        }

        #pagediv input[type="text"] {
            background-color: #f0f0f0;
        }

        #pagediv label {
            color: black;
        }

        /* 图片加载相关样式 */
        .img-container {
            position: relative;
            display: inline-block;
        }

        .img-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
            font-size: 12px;
            color: #666;
        }

        /* 加载动画 */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 弹窗样式 */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            position: relative;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
            transform: scale(0.95);
        }

        .popup-overlay.active .popup-content {
            transform: scale(1);
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 32px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: color 0.2s ease;
            z-index: 10;
        }

        .close-btn:hover {
            color: #ff0000;
        }

        #popup-img {
            display: block;
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 85vh;
            margin: 0 auto;
            object-fit: contain;
        }

        table.list td img {
            max-width: 120px;
            max-height: 90px;
            cursor: pointer;
            transition: transform 0.3s;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: none; /* 初始隐藏，加载成功后显示 */
        }

        table.list td img.visible {
            display: inline-block;
        }

        table.list td img:hover {
            transform: scale(1.1);
        }

        /* 图片加载失败占位图样式 */
        .img-placeholder {
            width: 120px;
            height: 90px;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #999;
            font-size: 12px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: none;
        }

        .img-placeholder.visible {
            display: flex;
        }
    </style>

</head>
<body>

<div class="popup-overlay" id="popup">
    <div class="popup-content" id="popup-content">
        <span class="close-btn" id="close-btn">&times;</span>
        <img src="" id="popup-img">
    </div>
</div>

<div id="pagediv">
    <form id="searchForm" action="/shexiangtoufind/shexiangtoulist" method="post">
        <label>摄像头编号:</label>
        <input type="text" name="shexiangtouno" value="#(shexiangtouno)">
        <label>发生日期:</label>
        <input type="date" name="searchDate" id="searchDate" value="#(searchDate)">
        <label>发生时间:</label>
        <input type="time" name="searchTime" id="searchTime" value="#(searchTime??)" step="1">
        <label>&nbsp;</label>
        <input value="搜索" type="submit">
        <input type="button" value="重置" name="refresh" id="resetButton" />
    </form>
</div>

<table class="list">
    <tbody>
    <tr>
        <th width="3%">id</th>
        <th width="12%">摄像头编号</th>
        <th width="12%">发生时间</th>
        <th width="10%">报警图片</th>
        <th width="10%">报警信息</th>
        <th width="10%">饭店名称</th>
        <th width="10%">饭店电话</th>
        <th width="10%">饭店地址</th>
        <th width="10%">cpu 温度</th>
        <th width="10%">系统错误信息</th>
    </tr>
    #set(startIndex = (shexiangtou.pageNumber - 1) * shexiangtou.pageSize + 1)
    #for(x : shexiangtou.getList())
    <tr>
        <td style="text-align:center">#(startIndex++)</td>
        <td style="text-align:center">#(x.shexiangtouno)</td>
        <td style="text-align:center">#(x.happendtime)</td>
        <td style="text-align:center">
            <!-- 图片容器：包含加载指示器、实际图片和失败占位图 -->
            <div class="img-container">
                <div class="img-loading">
                    <div class="loading-spinner"></div>
                    <span>加载中...</span>
                </div>
                <img
                        data-img-name="#(x.Alarmpic)"
                        src=""
                        alt="报警图片"
                        onload="this.classList.add('visible')"
                >
                <div class="img-placeholder">图片加载失败<br>点击重试</div>
            </div>
        </td>
        <td style="text-align:center">#(x.alarmmes)</td>
        <td style="text-align:center">#(x.restaurantname)</td>
        <td style="text-align:center">#(x.restaurantphone)</td>
        <td style="text-align:center">#(x.restaurantaddress)</td>
        <td style="text-align:center">#(x.memo)</td>
        <td style="text-align:center">#(x.alarmtype)</td>
    </tr>
    #end
    </tbody>
</table>

<div class="pagination" style="color:#000000;">
    #set(pageUrl = "/shexiangtoufind/shexiangtoulist?shexiangtouno=" + shexiangtouno + "&searchDate=" + (searchDate ??"") +"&searchTime=" +(searchTime ??"") + "&page=")
    #@paginate(shexiangtou.pageNumber, shexiangtou.totalPage, pageUrl)
</div>

<script>
    // 页面加载完成后初始化所有图片加载
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.img-container img').forEach(img => {
            loadImage(img);
        });
    });

    // 图片加载函数 - 带重试机制和缓存控制
    function loadImage(imgElement) {
        const imageName = imgElement.getAttribute('data-img-name');
        if (!imageName) {
            handleLoadError(imgElement);
            return;
        }

        const container = imgElement.parentElement;
        const loading = container.querySelector('.img-loading');
        const placeholder = container.querySelector('.img-placeholder');

        // 重置状态
        imgElement.classList.remove('visible');
        placeholder.classList.remove('visible');
        loading.style.display = 'flex';

        // 端口列表和重试次数设置
        const ports = [8100, 8101];
        const maxRetries = 2; // 每个端口最多重试2次
        let currentPortIndex = 0;
        let currentRetry = 0;

        // 生成带时间戳的URL，避免缓存问题
        function getImageUrl(port) {
            return `http://39.98.221.201:${port}/upload/temp/${imageName}?t=${new Date().getTime()}`;
        }

        // 尝试加载图片
        function tryLoad() {
            const img = new Image();
            const currentPort = ports[currentPortIndex];
            img.src = getImageUrl(currentPort);

            img.onload = function() {
                // 加载成功，更新图片源并显示
                imgElement.src = img.src;
                loading.style.display = 'none';
                bindClickEvent(imgElement); // 绑定点击事件
            };

            img.onerror = function() {
                currentRetry++;
                // 如果当前端口重试次数未达上限，继续重试
                if (currentRetry < maxRetries) {
                    setTimeout(tryLoad, 500); // 500ms后重试
                } else {
                    // 当前端口重试完毕，切换到下一个端口
                    currentPortIndex++;
                    currentRetry = 0;
                    if (currentPortIndex < ports.length) {
                        tryLoad(); // 尝试下一个端口
                    } else {
                        // 所有端口都尝试失败
                        handleLoadError(imgElement);
                    }
                }
            };
        }

        // 开始加载
        tryLoad();
    }

    // 处理加载失败
    function handleLoadError(imgElement) {
        const container = imgElement.parentElement;
        const loading = container.querySelector('.img-loading');
        const placeholder = container.querySelector('.img-placeholder');

        loading.style.display = 'none';
        placeholder.classList.add('visible');

        // 绑定点击重试事件
        placeholder.onclick = function() {
            loadImage(imgElement);
        };
    }

    // 绑定图片点击事件
    function bindClickEvent(element) {
        // 先移除已有的事件监听，避免重复绑定
        element.onclick = null;
        element.onclick = () => {
            showPopup(element.src);
        };
    }

    // 弹窗显示函数
    function showPopup(imgSrc) {
        var popup = document.getElementById('popup');
        var popupImg = document.getElementById('popup-img');

        // 显示加载状态
        popupImg.src = '';
        popupImg.style.display = 'none';
        popup.style.display = 'flex';
        popup.classList.add('active');

        // 加载弹窗图片
        const tempImg = new Image();
        tempImg.src = imgSrc;
        tempImg.onload = function() {
            popupImg.src = imgSrc;
            popupImg.style.display = 'block';
        };

        // 点击弹窗背景关闭
        popup.addEventListener('click', function(e) {
            if (e.target === popup) {
                closePopup();
            }
        });
    }

    // 关闭弹窗函数
    function closePopup() {
        var popup = document.getElementById('popup');
        popup.classList.remove('active');

        setTimeout(() => {
            popup.style.display = 'none';
        }, 300);
    }

    // 关闭按钮事件
    document.getElementById('close-btn').addEventListener('click', closePopup);

    // ESC键关闭弹窗
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePopup();
        }
    });

    // 弹窗拖拽功能
    let isDragging = false;
    let offsetX, offsetY;
    const popupContent = document.getElementById('popup-content');

    popupContent.addEventListener('mousedown', (e) => {
        if (e.button === 0 && (e.target === popupContent || e.target === document.getElementById('popup-img'))) {
            isDragging = true;
            offsetX = e.clientX - popupContent.offsetLeft;
            offsetY = e.clientY - popupContent.offsetTop;
            popupContent.style.cursor = 'grabbing';
        }
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
        popupContent.style.cursor = 'grab';
    });

    document.addEventListener('mousemove', (e) => {
        if (isDragging) {
            const x = e.clientX - offsetX;
            const y = e.clientY - offsetY;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const popupWidth = popupContent.offsetWidth;
            const popupHeight = popupContent.offsetHeight;
            const maxX = viewportWidth - popupWidth;
            const maxY = viewportHeight - popupHeight;
            const constrainedX = Math.max(0, Math.min(x, maxX));
            const constrainedY = Math.max(0, Math.min(y, maxY));

            popupContent.style.left = `${constrainedX}px`;
            popupContent.style.top = `${constrainedY}px`;
        }
    });

    // 重置按钮功能
    document.getElementById('resetButton').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('searchForm').reset();
        document.querySelector('input[name="shexiangtouno"]').value = '';
        document.getElementById('searchDate').value = '';
        document.getElementById('searchTime').value = '';
        document.getElementById('searchForm').submit();
    });
</script>
</body>
</html>